@using AppData.Models
@using AppData.ViewModels
@model List<DonMuaChiTietViewModel>
@{
    Layout = "_Layout";
    // Các biến tính toán giữ nguyên
    int tongtien = 0;
    int giaSP = 0;
    int tienShip = 0;
    int? giaTri = null;
    int? hinhThucGiamGia = null;
    int diemSudung = 0;
    int diemTich = 0;
    int trangThaiLichSuTichDiem = 1;
    int tileTieuDiem = 0;
    int tileTichDiem = 0;
    var trangthaiGiaoHang = 0;
    var ngaythanhToan = DateTime.Now;
    int trangthaiDanhGia = 0;
    string tennguoinhan = "";
    string SDT = "";
    string email = "";
    string diachi = "";
    string phuongthucthanhtoan = "";
    int loaiHD = 0;
    List<LichSuTichDiem> lichSuTichDiems = new List<LichSuTichDiem>();

    var idHoaDon = Model.FirstOrDefault()?.ID ?? Guid.Empty;
}
<style>
    #navbar {
        display: flex;
        justify-content: space-evenly;
        align-items: center;
        padding: 10px 0px 10px 0px;
        background-color: white;
        margin-bottom: 24px;
    }
    /* ... CSS giữ nguyên ... */
    #AllHoaDon {
        display: flex;
        justify-content: space-evenly;
        align-items: center;
        background-color: white;
    }

    #navbar div label {
        margin: 0px;
    }

        #navbar div label span {
            cursor: pointer;
            padding: 10px;
        }

    #navbar input[type="radio"] {
        display: none;
    }

    #navbar label input[type="radio"]:checked ~ span {
        border-bottom: 1px solid black;
    }

    .table td {
        vertical-align: middle;
    }
</style>

<section style="background-color: #eee;">
    <div class="container py-5">
        <div class="row">
            <div class="col">
                <nav aria-label="breadcrumb" class="bg-light rounded-3 p-3 mb-4">
                    <ol class="breadcrumb mb-0">
                        <li class="breadcrumb-item"><a href="https://localhost:5001/">Trang chủ</a></li>
                        <li class="breadcrumb-item"><a asp-controller="Home" asp-action="PurchaseOrder">Đơn hàng</a></li>
                        <li class="breadcrumb-item active" aria-current="page">Đơn hàng chi tiết</li>
                    </ol>
                </nav>
            </div>
        </div>
        <div class="row">
            <div class="col">
                <nav aria-label="breadcrumb" class="bg-light rounded-3 p-3 mb-4">
                    <ol class="breadcrumb mb-0">
                        @if (Model.FirstOrDefault().TrangThaiGiaoHang == 2)
                        {
                            <li class="breadcrumb-item active" aria-current="page">Chờ xác nhận</li>
                        }
                        else if (Model.FirstOrDefault().TrangThaiGiaoHang == 3)
                        {
                            <li class="breadcrumb-item active" aria-current="page">Đang giao hàng</li>
                        }
                        else if (Model.FirstOrDefault().TrangThaiGiaoHang == 11)
                        {
                            <li class="breadcrumb-item active" aria-current="page">Giao hàng không thành công</li>
                        }
                        else if (Model.FirstOrDefault().TrangThaiGiaoHang == 4)
                        {
                            <li class="breadcrumb-item active" aria-current="page">Đang hoàn hàng</li>
                        }
                        else if (Model.FirstOrDefault().TrangThaiGiaoHang == 5)
                        {
                            <li class="breadcrumb-item active" aria-current="page">Hoàn hàng thành công</li>
                        }
                        else if (Model.FirstOrDefault().TrangThaiGiaoHang == 6)
                        {
                            <li class="breadcrumb-item active" aria-current="page">Hoàn thành</li>
                        }
                        else if (Model.FirstOrDefault().TrangThaiGiaoHang == 7)
                        {
                            <li class="breadcrumb-item active" aria-current="page">Đơn hủy</li>
                        }
                        else if (Model.FirstOrDefault().TrangThaiGiaoHang == 8)
                        {
                            <li class="breadcrumb-item active" aria-current="page">Chờ xác nhận hủy</li>
                        }
                        else if (Model.FirstOrDefault().TrangThaiGiaoHang == 9)
                        {
                            <li class="breadcrumb-item active" aria-current="page">Chờ xác nhận hoàn hàng</li>
                        }
                        else if (Model.FirstOrDefault().TrangThaiGiaoHang == 10)
                        {
                            <li class="breadcrumb-item active" aria-current="page">Chờ đóng hàng</li>
                        }
                    </ol>
                </nav>
            </div>
        </div>

        <div class="shopping__cart__table">
            <table class="table" style="background-color:white;margin-bottom:0px">
                <thead>
                    <tr>
                        <th>Sản phẩm</th>
                        <th>Đơn giá</th>
                        <th>Số lượng</th>
                        <th>Thành tiền</th>
                        @if (Model.FirstOrDefault().TrangThaiGiaoHang == 6)
                        {
                            <th></th>
                        }
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model)
                    {
                        <tr>
                            <td class="product__cart__item">
                                <div class="product__cart__item__pic">
                                    <img style="width:90px;height:90px;" src="/img/product/@item.DuongDan" alt="">
                                </div>
                                <div class="product__cart__item__text">
                                    <h6>@item.TenSanPham</h6>
                                    <h5>@item.TenKichCo/@item.TenMau</h5>
                                </div>
                            </td>
                            <td class="cart__price">@item.DonGia.ToString("n0").Replace(',', '.') VNĐ</td>
                            <td class="cart__price">@item.SoLuong</td>
                            <td class="cart__price">@((item.DonGia * item.SoLuong).ToString("n0").Replace(',', '.')) VNĐ</td>
                            @if (item.TrangThaiGiaoHang == 6 && item.TrangThaiDanhGia == 0)
                            {
                                <td class="cart__price">
                                    <div style="border: none; color: white; background-color: black; text-align:center;">
                                        <a style="color:white;" asp-controller="Home" asp-action="ReviewProducts" asp-route-idCTHD="@item.IDCTHD">Đánh giá sản phẩm</a>
                                    </div>
                                </td>
                            }

                            @{
                                // Logic tính toán giữ nguyên
                                giaSP += item.DonGia * item.SoLuong;
                                tienShip = item.TienShip;
                                giaTri = item.GiaTri;
                                diemSudung = item.lichSuTichDiems.FirstOrDefault(p => p.TrangThai == 0) != null ? item.lichSuTichDiems.FirstOrDefault(p => p.TrangThai == 0).Diem : 0;
                                diemTich = item.lichSuTichDiems.FirstOrDefault(p => p.TrangThai == 1) != null ? item.lichSuTichDiems.FirstOrDefault(p => p.TrangThai == 1).Diem : 0;
                                trangThaiLichSuTichDiem = item.lichSuTichDiems.FirstOrDefault(p => p.TrangThai == 0) != null ? 0 : 1;
                                hinhThucGiamGia = item.HinhThucGiamGia;
                                tileTieuDiem = item.TiLeTieuDiem;
                                tileTichDiem = item.TiLeTichDiem;
                                trangthaiGiaoHang = item.TrangThaiGiaoHang;
                                ngaythanhToan = Convert.ToDateTime(item.NgayThanhToan);
                                trangthaiDanhGia += item.TrangThaiDanhGia;
                                lichSuTichDiems = item.lichSuTichDiems;
                                tennguoinhan = item.TenNguoiNhan;
                                SDT = item.SDT;
                                email = item.Email;
                                diachi = item.DiaChi;
                                phuongthucthanhtoan = item.PhuongThucThanhToan;
                                loaiHD = item.LoaiHoaDon;
                            }
                        </tr>
                    }
                </tbody>
                <tfoot>
                    <table style="background-color:white;">
                        <tbody>
                            @{
                                // Logic tính tổng tiền giữ nguyên
                                if (hinhThucGiamGia == 1)
                                {
                                    if (trangThaiLichSuTichDiem == 0) { tongtien = Convert.ToInt32(giaSP - giaSP * (Convert.ToDouble(giaTri) / 100)) + tienShip - diemSudung * tileTieuDiem; }
                                    else { tongtien = Convert.ToInt32(giaSP - giaSP * (Convert.ToDouble(giaTri) / 100)) + tienShip; }
                                }
                                else if (hinhThucGiamGia == 0)
                                {
                                    if (trangThaiLichSuTichDiem == 0) { tongtien = giaSP - Convert.ToInt32(giaTri) + tienShip - diemSudung * tileTieuDiem; }
                                    else { tongtien = giaSP - Convert.ToInt32(giaTri) + tienShip; }
                                }
                                else
                                {
                                    if (trangThaiLichSuTichDiem == 0) { tongtien = giaSP + tienShip - diemSudung * tileTieuDiem; }
                                    else { tongtien = giaSP + tienShip; }
                                }
                                int diemsudung = diemSudung * tileTieuDiem;
                            }
                            <tr>
                                <td style="padding-left: 20px;color: #111111;font-size: 18px;font-weight: 700;width: 70%;">Giá sản phẩm</td>
                                <td style="padding-left: 20px;color: #111111;font-size: 18px;font-weight: 700;width: 130px;padding-right: 70px; text-align: right;">@giaSP.ToString("n0").Replace(',', '.') VNĐ</td>
                            </tr>
                            @if (loaiHD == 0)
                            {
                                <tr>
                                    <td style="padding-left: 20px;color: #111111;font-size: 18px;font-weight: 700;">Phí vận chuyển</td>
                                    <td style="padding-left: 20px;color: #111111;font-size: 18px;font-weight: 700;width: 130px;padding-right: 70px; text-align: right;"> @tienShip.ToString("n0").Replace(',', '.') VNĐ</td>
                                </tr>
                            }
                            @if (hinhThucGiamGia == 1)
                            {
                                <tr>
                                    <td style="padding-left: 20px;color: #111111;font-size: 18px;font-weight: 700;">Voucher</td>
                                    <td style="padding-left: 20px;color: #111111;font-size: 18px;font-weight: 700;width: 130px;padding-right: 70px; text-align: right;">- @giaTri%</td>
                                </tr>
                            }
                            else if (hinhThucGiamGia == 0)
                            {
                                <tr>
                                    <td style="padding-left: 20px;color: #111111;font-size: 18px;font-weight: 700;">Voucher</td>
                                    <td style="padding-left: 20px;color: #111111;font-size: 18px;font-weight: 700;width: 130px;padding-right: 70px; text-align: right;">- @Convert.ToInt32(giaTri).ToString("n0").Replace(',', '.') VNĐ</td>
                                </tr>
                            }
                            @{
                                foreach (var item in lichSuTichDiems)
                                {
                                    if (item.TrangThai == 0 && diemsudung > 0)
                                    {
                                        <tr>
                                            <td style="padding-left: 20px;color: #111111;font-size: 18px;font-weight: 700;">Điểm sử dụng</td>
                                            <td style="padding-left: 20px;color: #111111;font-size: 18px;font-weight: 700;width: 130px;padding-right: 70px; text-align: right;">- @diemsudung.ToString("n0").Replace(',', '.') VNĐ</td>
                                        </tr>
                                    }
                                }
                            }
                            <tr>
                                <td style="padding-left: 20px;color: #111111;font-size: 18px;font-weight: 700;">Tổng tiền</td>
                                <td style="padding-left: 20px;color: #111111;font-size: 18px;font-weight: 700;width: 130px;padding-right: 70px; text-align: right;">@tongtien.ToString("n0").Replace(',', '.') VNĐ</td>
                            </tr>
                        </tbody>
                    </table>
                </tfoot>
            </table>
        </div>

        <div class="row" style="margin-bottom:30px;">
            <div class="col-6">
                @{
                    if (loaiHD == 0)
                    {
                        <div style="background-color: #d9edf7; border: 1px solid #bce8f1; padding: 10px;">
                            <h4>Địa Chỉ Nhận Hàng</h4>
                        </div>
                        <div style="background-color: white; padding: 10px;">
                            <div style="font-weight: bold;padding: 5px;">@tennguoinhan</div>
                            <div style="padding: 5px;">@diachi</div>
                            <div style="padding: 5px;">@SDT</div>
                            <div style="padding: 5px;">@email</div>
                        </div>
                    }
                }
            </div>
            <div class="col-6">
                <table class="table" style="background-color:white;width: 100%;height: 100%;">
                    <tbody>
                        @foreach (var item in lichSuTichDiems)
                        {
                            @* Logic hiển thị điểm đã comment lại *@
                        }
                        <tr style="height:88px;">
                            <td style="padding-left: 20px;color: #111111;font-size: 18px;font-weight: 700;">Phương thức thanh toán</td>
                            <td style="padding-left: 20px;color: #111111;font-size: 18px;font-weight: 700;width: auto;padding-right: 70px; text-align: right;">@phuongthucthanhtoan</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        @if (trangthaiGiaoHang == 2)
        {
            <div style="text-align:-webkit-right ;">
                <div style="border: none; color: white; background-color: black; text-align:center;width: 150px; height: 50px; display: grid; align-items: center; cursor: pointer;">
                    <button type="button" onclick="showCancelModal('@idHoaDon')" style="color:white; background:none; border:none; width:100%; height:100%;">
                        Hủy đơn hàng
                    </button>
                </div>
            </div>
        }
        else if (trangthaiGiaoHang == 6 && DateTime.Now.Subtract(ngaythanhToan).TotalDays < 3 && trangthaiDanhGia == 0)
        {
            <div style="text-align:-webkit-right ;">
                <div style="border: none; color: white; background-color: black; text-align:center;width: 150px; height: 50px; display: grid; align-items: center;">
                    <a style="color:white;" asp-controller="Home" asp-action="DoiTraHang" asp-route-idHoaDon="@idHoaDon">Hoàn hàng</a>
                </div>
            </div>
        }
        else if (trangthaiGiaoHang == 8)
        {
            <div style="text-align:-webkit-right ;">
                <div style="border: none; color: white; background-color: black; text-align:center;width: 150px; height: 50px; display: grid; align-items: center;">
                    <a style="color:white;" asp-controller="Home" asp-action="HoanTacHuyDonHang" asp-route-idHoaDon="@idHoaDon">Hoàn tác hủy đơn hàng</a>
                </div>
            </div>
        }
        else if (trangthaiGiaoHang == 9)
        {
            <div style="text-align:-webkit-right ;">
                <div style="border: none; color: white; background-color: black; text-align:center;width: 150px; height: 50px; display: grid; align-items: center;">
                    <a style="color:white;" asp-controller="Home" asp-action="HoanTacDoiTraHang" asp-route-idHoaDon="@idHoaDon">Hoàn tác hoàn hàng</a>
                </div>
            </div>
        }
        else if (trangthaiGiaoHang == 3)
        {
            <div style="text-align:-webkit-right ;">
                <div style="border: none; color: white; background-color: black; text-align:center;width: 150px; height: 50px; display: grid; align-items: center;">
                    <a style="color:white;" asp-controller="Home" asp-action="XacNhanGHTC" asp-route-idHoaDon="@idHoaDon">Xác nhận giao hàng thành công</a>
                </div>
            </div>
        }
    </div>
</section>

<div class="modal fade" id="cancelOrderModal" tabindex="-1" aria-labelledby="cancelOrderModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cancelOrderModalLabel">Xác nhận hủy đơn hàng</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Bạn có chắc chắn muốn hủy đơn hàng này không? Bạn có thể để lại lý do (không bắt buộc):</p>
                <textarea id="cancelReasonInput" class="form-control" rows="3" placeholder="Nhập lý do hủy đơn..."></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Không</button>
                <button type="button" class="btn btn-danger" id="confirmCancelBtn">Xác nhận hủy</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        var cancelOrderModal;
        var orderIdToCancel;

        $(document).ready(function () {
            // Khởi tạo Modal
            if (document.getElementById('cancelOrderModal')) {
                cancelOrderModal = new bootstrap.Modal(document.getElementById('cancelOrderModal'), {});
            }

            // Sự kiện nút "Xác nhận hủy"
            $("#confirmCancelBtn").click(function () {
                var reason = $("#cancelReasonInput").val(); // Lấy lý do (có thể rỗng)

                // Gọi Ajax
                $.ajax({
                    url: '@Url.Action("HuyDonHang", "Home")', // Gọi đến HomeController
                    type: 'POST',
                    data: {
                        idHoaDon: orderIdToCancel,
                        ghiChu: reason // Gửi lý do lên server
                    },
                    success: function (response) {
                        if (response.success) {
                            toastr.success("Đã gửi yêu cầu hủy đơn hàng.");
                            location.reload(); // Tải lại trang để cập nhật trạng thái
                        } else {
                            toastr.error(response.message || "Hủy đơn thất bại.");
                        }
                        cancelOrderModal.hide();
                    },
                    error: function () {
                        toastr.error("Có lỗi xảy ra, vui lòng thử lại.");
                        cancelOrderModal.hide();
                    }
                });
            });
        });

        // Hàm hiển thị Modal
        function showCancelModal(orderId) {
            orderIdToCancel = orderId;
            $("#cancelReasonInput").val(''); // Xóa trắng ô nhập

            if (cancelOrderModal) {
                cancelOrderModal.show();
            }
        }
    </script>
}