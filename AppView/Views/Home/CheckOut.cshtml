@using AppData.Models;
@using AppData.ViewModels;
@using Newtonsoft.Json;
@{
    LoginViewModel loginInfor = new LoginViewModel();
    string? session = Context.Session.GetString("LoginInfor");
    if (session != null)
    {
        loginInfor = JsonConvert.DeserializeObject<LoginViewModel>(Context.Session.GetString("LoginInfor"));
        string apiUrl = $"https://localhost:7095/api/KhachHang/GetById?id={loginInfor.Id}";
        using (var client = new System.Net.Http.HttpClient())
        {
            var response = client.GetAsync(apiUrl).Result;
            if (response.IsSuccessStatusCode)
            {
                var apiResponse = response.Content.ReadAsStringAsync().Result;
                var user = JsonConvert.DeserializeObject<KhachHangViewModel>(apiResponse);
                if (user != null)
                {
                    loginInfor.DiemTich = user.DiemTich;
                }
            }
        }
    }
  
    string? tongtien = Context.Session.GetString("TongTien");

    string? soLuong = Context.Session.GetString("Quantity");
    long tienship = 0;
    Layout = "_Layout";
}
<style>
    a:hover {
        text-decoration: none;
        outline: none;
        color: black;
    }
</style>
<section class="breadcrumb-option">
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <div class="breadcrumb__text">
                    <h4>Thanh toán</h4>
                    <div class="breadcrumb__links">
                        <a href="./index.html">Trang chủ</a>
                        <a href="./shop.html">Cửa hàng</a>
                        <span>Thanh toán</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
<section class="checkout spad">
    <div class="container">
        <div class="checkout__form">
            <div class="row">
                <div class="col-lg-8 col-md-6">
                    <h6 class="checkout__title">Chi tiết thanh toán</h6>

                    <div class="row">
                        <div class="col-lg-12">
                            <div class="checkout__input">
                                <label for="ten">Họ và tên</label>
                                <input type="text" class="form-control" id="name" placeholder="" value="@loginInfor.Ten" required="" style="height:38px; color:#000;">
                                <div class="invalid-feedback"> Không để trống tên</div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-lg-6">
                            <div class="checkout__input">
                                <label for="sdt">Số điện thoại</label>
                                <input type="text" class="form-control" id="phone" placeholder="" value="@loginInfor.SDT" required="" style="height:38px;color: #000;">
                                <div class="invalid-feedback"> Không để trống SDT </div>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="checkout__input">
                                <label for="email">Email</label>
                                <input type="text" class="form-control" id="email" placeholder="" value="@loginInfor.Email" required="" style="height:38px;color: #000;">
                                <div class="invalid-feedback"> Không để trống email </div>
                            </div>
                        </div>
                    </div>

                    <hr style="margin-top: 1.5rem; margin-bottom: 1.5rem;">

                    <div id="diaChiDaLuuContainer" style="display: none;">
                        <h5>Địa chỉ nhận hàng</h5>

                        <div class="d-flex flex-column align-items-start w-100">

                            <button type="button" class="btn btn-light border w-100" id="btnChonDiaChi" data-bs-toggle="modal" data-bs-target="#diaChiModal" style="text-align: left; padding: 0.75rem; line-height: 1.5;">

                                <span id="diaChiDaChonText" style="white-space: normal;">Chọn địa chỉ nhận hàng</span>
                            </button>

                            <button type="button" id="btnSuDungDiaChiMoi_DaLuu" class="btn btn-light border" style="white-space: nowrap; padding: 0.75rem 1rem;">

                                Sử dụng địa chỉ mới

                            </button>
                        </div>
                    </div>

                    <div id="diaChiMoiContainer" style="display: none;">

                        <h5>Địa chỉ nhận hàng</h5>
                        <button type="button" id="btnQuayLaiDanhSach" class="btn btn-link" style="display: none; padding-left: 0; text-decoration: underline;">
                            &larr; Quay lại danh sách địa chỉ
                        </button>

                        <div class="row">
                            <div class="col-lg-12">
                                <div class="checkout__input">
                                    <label for="diachi">Địa chỉ</label>
                                    <input type="text" class="form-control" id="address" placeholder="" required="" style="height:38px">
                                    <div class="invalid-feedback"> Valid first name is required. </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-check mt-2 mb-3" id="saveAddressCheckboxContainer" style="display: none;">
                            <input class="form-check-input" type="checkbox" id="saveAddressCheckbox" checked>
                            <label class="form-check-label" for="saveAddressCheckbox" style="padding-left: 5px;">
                                Lưu địa chỉ này vào Sổ địa chỉ
                            </label>
                        </div>
                    </div>

                    <div class="row" id="tinhHuyenXaContainer">
                        <div class="col-lg-4">
                            <div class="checkout__input">
                                <label for="tinh">Tỉnh / thành</label>
                                <select class="custom-select d-block w-100" id="province" required="">
                                    <option selected id="dfprovince" value="">Chọn tỉnh / thành</option>
                                </select>
                                <div class="invalid-feedback"> Tên hợp lệ là bắt buộc. </div>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="checkout__input">
                                <label for="huyen">Quận / huyện</label>
                                <select class="custom-select d-block w-100" id="district" required="">
                                    <option selected id="dfdistrict" value="">Chọn quận / huyện</option>
                                </select>
                                <div class="invalid-feedback"> Tên hợp lệ là bắt buộc. </div>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="checkout__input">
                                <label for="xa">Phường / xã</label>
                                <select class="custom-select d-block w-100" id="ward" required="">
                                    <option selected id="dfward" value="">Chọn phường / xã</option>
                                </select>
                                <div class="invalid-feedback"> Tên hợp lệ là bắt buộc. </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-lg-12">
                            <div class="checkout__input">
                                <label for="pttt">Phương thức thanh toán</label>
                                <div style="box-shadow:0 0 0 1px #d9d9d9;border-radius:0.25rem">
                                    <div style="display:flex!important;align-items:center;padding:0.8rem">
                                        <input type="radio" name="pttt" value="COD" style="margin-bottom: 0px;width:20px;" />
                                        <img style="padding-left:0.75rem" src="https://hstatic.net/0/0/global/design/seller/image/payment/cod.svg?v=6">
                                        <p style="margin-bottom: 0px;padding-left: 10px;">Thanh toán khi giao hàng (COD)</p>
                                    </div>
                                    <div style="border-top: 1px solid #d9d9d9;display:flex!important;align-items:center;padding:0.8rem">
                                        <input type="radio" name="pttt" value="VNPay" style="margin-bottom: 0px;width:20px" />
                                        <div style="width:40px;height:40px;margin-left:0.75rem;border:1px solid #d9d9d9;border-radius:0.25rem">
                                            <img style="width:30px;height:30px;margin:5px" src="/img/icon/vnpay.png">
                                        </div>
                                        <p style="margin-bottom: 0px;padding-left: 10px;">Chuyển khoản qua VNPay</p>
                                    </div>
                                </div>
                                <div id="pttt-error" style="display:none;color:red">Vui lòng chọn phương thức thanh toán</div>
                                <div id="pttt-error" style="display:none;color:red; font-size:12px;">Vui lòng chọn phương thức thanh toán</div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-lg-12">
                            <div class="checkout__input">
                                <label for="ten">Ghi chú</label>
                                <textarea class="form-control" id="note" placeholder="" value=""></textarea>
                                <div class="invalid-feedback"> Không để trống tên</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4 col-md-6">
                    <div class="cart__discount" style="margin-bottom:20px!important">
                        <h6>Hình thức giảm giá</h6>
                        <div style="position:relative;margin-bottom:5px">
                            <input type="text" id="voucher" placeholder="Nhập mã giảm giá" style="font-size:14px;color: #000;;height: 50px;width: 100%;border: 1px solid #e1e1e1;padding-left: 20px;" list="vouchers" />
                            <datalist id="vouchers">
                            </datalist>
                            <button onclick="usevoucher()" style="font-size: 14px;color: #ffffff;font-weight: 700;letter-spacing: 2px;text-transform: uppercase;background: #111111;padding: 0 30px;border: none;position: absolute;right: 0;top: 0;height: 100%;">
                                Áp dụng
                            </button>
                        </div>
                        @if (session != null)
                        {
                        }
                        else
                        {
                        }
                    </div>
                    <div class="checkout__order">
                        <h4 class="order__title">Đơn hàng của bạn</h4>
                        <ul class="checkout__order__products">
                            <li>Tiền hàng <span id="tienHang"></span></li>
                            <li id="moneyvoucher" hidden></li>
                            <li id="moneyscore" hidden></li>
                            <li>Tiền ship <span id="fee">0 VND</span></li>
                            <li>Tổng tiền <span id="total"></span></li>
                        </ul>
                        <button onclick="createhoadon()" class="site-btn">
                            XÁC NHẬN
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="diaChiModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Chọn địa chỉ của bạn</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="diaChiListModal" style="max-height: 450px; overflow-y: auto;">
                </div>
            </div>
        </div>
    </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="~/js/jquery-3.3.1.min.js"></script>
<script type="text/javascript">
    var ghnToken = '6092d580-fde7-11ed-a967-deea53ba3605';
    var ghnShopID = 4185066;
    var fromDistrictID = 3440; 
    var packageLength = 38; 
    var packageWidth = 15;
    var packageHeight = 15;

    var isLoggedIn = @(session != null ? "true" : "false");
    var currentUserID = isLoggedIn ? "@loginInfor.Id" : null;

    var tienShip = 0;
    var tienDiem = 0;
    var tienVoucher = 0;
    var tinh = "";
    var huyen = "";
    var xa = "";
    var voucher = "";
    var diemTich = 0;

    var tienHang = @(string.IsNullOrEmpty(tongtien) ? "0" : tongtien);
    var soLuongString = "@(string.IsNullOrEmpty(soLuong) ? "1" : soLuong)";
    var soLuongInt = parseInt(soLuongString) || 1;
    var weight = Math.max(500 * soLuongInt, 1000);

    function resetShipFeeAndTotal() {
        tienShip = 0;
        document.getElementById("fee").innerHTML = "0 VND";
        var total = tienHang - tienVoucher - tienDiem;
        if (total < 0) total = 0;
        document.getElementById("total").innerHTML = total.toLocaleString('it-IT', { style: 'currency', currency: 'VND' });
    }

    $(document).ready(function () {
        loadDiaChiDaLuu(currentUserID);

        $('#btnSuDungDiaChiMoi_DaLuu').on('click', function () {
            $('#diaChiDaLuuContainer').hide();
            $('#diaChiMoiContainer').show();
            $('#btnQuayLaiDanhSach').show();
            if (isLoggedIn) {
                $('#saveAddressCheckboxContainer').show();
            }
            clearDiaChiForm();
        });

        $('#btnQuayLaiDanhSach').on('click', function () {
            $('#diaChiDaLuuContainer').show();
            $('#diaChiMoiContainer').hide();
            $('#btnQuayLaiDanhSach').hide();
            $('#saveAddressCheckboxContainer').hide();
            loadDiaChiDaLuu(currentUserID);
        });

        $(document).on('change', 'input[name="diaChiRadio"]', function () {
            var radio = $(this);
            var diaChi = JSON.parse(radio.attr('data-json'));

            fillDiaChiForm(diaChi);

            var btnText = `<span>${diaChi.diaChiCuThe}, ${diaChi.phuongXa}...</span>`;
            $('#diaChiDaChonText').html(btnText);

            $('#diaChiModal').modal('hide');
        });

        document.getElementById("tienHang").innerHTML = tienHang.toLocaleString('it-IT', { style: 'currency', currency: 'VND' });
        document.getElementById("total").innerHTML = tienHang.toLocaleString('it-IT', { style: 'currency', currency: 'VND' });

        $.ajax({
            type: "GET",
            url: "/Home/GetAllVoucherByTien",
            dataType: "json",
            data: { tongTien: tienHang },
            success: function (response) {
                $.each(response.ketQua, function (i, item) {
                    if (item.hinhThucGiamGia == 1) {
                        $("#vouchers").append(`<option value='${item.ten}'>(-${item.giaTri}%)</option>`)
                    }
                    else {
                        $("#vouchers").append(`<option value='${item.ten}'>(-${item.giaTri.toLocaleString('it-IT', { style: 'currency', currency: 'VND' })})</option>`)
                    }
                });
            },
            error: function (reponse) {
                console.log(reponse);
            }
        });

        $.ajax({
            type: "GET",
            url: "https://online-gateway.ghn.vn/shiip/public-api/master-data/province",
            headers: { token: ghnToken },
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (data) {
                for (var i = 0; i < data.data.length; i++) {
                    var rows = "<option id='" + data.data[i].ProvinceID + "' value='" + data.data[i].ProvinceID + "'>" + data.data[i].ProvinceName + "</option>";
                    $('#province').append(rows);
                }
            },
            error: function (reponse) {
                alert(reponse.responseText);
            }
        });

        $("#province").change(function () {
            var value = $(this).val();
            if (value == "") {
                tinh = "";
                $('#district').empty().append('<option selected id="dfdistrict" value="">Chọn quận / huyện</option>');
                $('#ward').empty().append('<option selected id="dfward" value="">Chọn phường / xã</option>');
                resetShipFeeAndTotal();
                return;
            }
            tinh = $(this).find("option:selected").text().trim();

            $.ajax({
                type: "GET",
                url: "https://online-gateway.ghn.vn/shiip/public-api/master-data/district?province_id=" + value,
                headers: { token: ghnToken },
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (data) {
                    $('#dfprovince').remove();
                    document.getElementById('district').innerHTML = '';
                    $('#district').append('<option selected id="dfdistrict" value="">Chọn quận / huyện</option>');
                    for (var i = 0; i < data.data.length; i++) {
                        var rows = "<option id='" + data.data[i].DistrictID + "' value='" + data.data[i].DistrictID + "'>" + data.data[i].DistrictName + "</option>";
                        $('#district').append(rows);
                    }
                },
                error: function (reponse) {
                    alert(reponse.responseText);
                }
            });
        });

        $("#district").change(function () {
            var value = $(this).val();
            if (value == "") {
                huyen = "";
                $('#ward').empty().append('<option selected id="dfward" value="">Chọn phường / xã</option>');
                resetShipFeeAndTotal();
                return;
            }
            huyen = $(this).find("option:selected").text().trim();

            $.ajax({
                type: "GET",
                url: "https://online-gateway.ghn.vn/shiip/public-api/master-data/ward?district_id=" + value,
                headers: { token: ghnToken },
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (data) {
                    $('#dfdistrict').remove();
                    document.getElementById('ward').innerHTML = '';
                    $('#ward').append('<option selected id="dfward" value="">Chọn phường / xã</option>');
                    for (var i = 0; i < data.data.length; i++) {
                        var rows = "<option id='" + data.data[i].WardCode + "' value='" + data.data[i].WardCode + "'>" + data.data[i].WardName + "</option>";
                        $('#ward').append(rows);
                    }
                },
                error: function (reponse) {
                    alert(reponse.responseText);
                }
            });
        });

        $("#ward").change(function () {
            var value1 = $(this).val();
            var value2 = $("#district").val();

            if (value1 == "" || value2 == "") {
                xa = "";
                resetShipFeeAndTotal();
                return;
            }

            xa = $(this).find("option:selected").text().trim();

            var feeUrl = "https://online-gateway.ghn.vn/shiip/public-api/v2/shipping-order/fee?" +
                         "to_ward_code=" + value1 +
                         "&to_district_id=" + value2 +
                         "&from_district_id=" + fromDistrictID +
                         "&weight=" + weight +
                         "&service_type_id=2" +
                         "&insurance_value=" + tienHang +
                         "&length=" + packageLength +
                         "&width=" + packageWidth +
                         "&height=" + packageHeight;

            $.ajax({
                type: "GET",
                url: feeUrl,
                headers: {
                    token: ghnToken,
                    shop_id: ghnShopID
                },
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (data) {
                    $('#dfward').remove();
                    tienShip = data.data.total;
                    document.getElementById("fee").innerHTML = data.data.total.toLocaleString('it-IT', { style: 'currency', currency: 'VND' });
                    var total = tienShip + tienHang - tienVoucher - tienDiem;
                    if (total < 0) {
                        total = 0
                    }
                    document.getElementById("total").innerHTML = total.toLocaleString('it-IT', { style: 'currency', currency: 'VND' });
                },
                error: function (reponse) {
                    console.error("Lỗi khi tính phí GHN (New Address):", reponse);
                    var errorMsg = "Lỗi khi tính phí GHN.";
                    if (reponse.responseJSON && reponse.responseJSON.code_message_value) {
                        errorMsg = reponse.responseJSON.code_message_value;
                    } else if (reponse.responseText) {
                         try { var jsonResponse = JSON.parse(reponse.responseText); errorMsg = jsonResponse.message || jsonResponse.code_message_value || errorMsg; } catch (e) { }
                    }
                    alert(errorMsg);
                    resetShipFeeAndTotal();
                }
            });
        });

        $('.checkout__input input').on('input', function () {
            $(this).removeClass('is-invalid');
            $(this).next('.invalid-feedback').text('');
        });
        $('.checkout__input select').change(function () {
            $(this).removeClass('is-invalid');
            $(this).next('.invalid-feedback').text('');
        });
        $('input[name="pttt"]').change(function () {
            $('#pttt-error').hide();
        });
    });

    function loadDiaChiDaLuu(idKhachHang) {
        if (!idKhachHang) {
            $('#diaChiMoiContainer').show();
            $('#diaChiDaLuuContainer').hide();
            $('#saveAddressCheckboxContainer').hide();
            return;
        }

        $.ajax({
            url: `https://localhost:7095/api/DiaChi/GetByKhachHang/${idKhachHang}`,
            type: 'GET',
            success: function (diaChis) {
                if (diaChis && diaChis.length > 0) {
                    var html = '';
                    var defaultAddress = null;

                    diaChis.forEach(function (diaChi) {
                        var checked = diaChi.isDefault ? 'checked' : '';
                        if (diaChi.isDefault) {
                            defaultAddress = diaChi;
                        }

                        var diaChiJson = JSON.stringify(diaChi);

                        html += `
                                    <div class="form-check border p-3 mb-2" style="border-radius: 0.25rem;">
                                        <input class="form-check-input" type="radio"
                                               name="diaChiRadio"
                                               id="diaChi-${diaChi.id}"
                                               value="${diaChi.id}"
                                               data-json='${diaChiJson}' ${checked}>
                                        <label class="form-check-label" for="diaChi-${diaChi.id}" style="width: 100%;">
                                            <span>${diaChi.diaChiCuThe}, ${diaChi.phuongXa}, ${diaChi.quanHuyen}, ${diaChi.tinhThanh}</span>
                                            ${diaChi.isDefault ? '<span class="badge bg-success ms-2">Mặc định</span>' : ''}
                                        </label>
                                    </div>
                                `;
                    });

                    $('#diaChiListModal').html(html);

                    $('#diaChiDaLuuContainer').show();
                    $('#diaChiMoiContainer').hide();
                    $('#btnQuayLaiDanhSach').hide();
                    $('#saveAddressCheckboxContainer').hide();

                    if (defaultAddress) {
                        fillDiaChiForm(defaultAddress);

                        // SỬA Ở ĐÂY: Hiển thị đầy đủ địa chỉ mặc định
                        var btnText = `<span>${defaultAddress.diaChiCuThe}, ${defaultAddress.phuongXa}, ${defaultAddress.quanHuyen}, ${defaultAddress.tinhThanh}</span>`;
                        $('#diaChiDaChonText').html(btnText);
                    }
                } else {
                    $('#diaChiMoiContainer').show();
                    $('#diaChiDaLuuContainer').hide();
                    if (isLoggedIn) {
                        $('#saveAddressCheckboxContainer').show();
                    }
                }
            },
            error: function () {
                $('#diaChiMoiContainer').show();
                $('#diaChiDaLuuContainer').hide();
            }
        });
    }

    function fillDiaChiForm(diaChi) {
        $('#address').val(diaChi.diaChiCuThe);
        $('#saveAddressCheckboxContainer').hide();

        tinh = diaChi.tinhThanh;
        huyen = diaChi.quanHuyen;
        xa = diaChi.phuongXa;

        if (diaChi.districtID && diaChi.wardCode) {
            $('#tinhHuyenXaContainer').hide();

            var feeUrlSaved = "https://online-gateway.ghn.vn/shiip/public-api/v2/shipping-order/fee?" +
                              "to_ward_code=" + diaChi.wardCode +
                              "&to_district_id=" + diaChi.districtID +
                              "&from_district_id=" + fromDistrictID +
                              "&weight=" + weight +
                              "&service_type_id=2" +
                              "&insurance_value=" + tienHang +
                              "&length=" + packageLength +
                              "&width=" + packageWidth +
                              "&height=" + packageHeight;

            $.ajax({
                type: "GET",
                url: feeUrlSaved,
                headers: {
                    token: ghnToken,
                    shop_id: ghnShopID
                },
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (data) {
                    tienShip = data.data.total;
                    $('#fee').text(tienShip.toLocaleString('it-IT', { style: 'currency', currency: 'VND' }));
                    var total = tienShip + tienHang - tienVoucher - tienDiem;
                    if (total < 0) total = 0;
                    document.getElementById("total").innerHTML = total.toLocaleString('it-IT', { style: 'currency', currency: 'VND' });
                },
                error: function (reponse) {
                    console.error("Lỗi khi tính phí GHN (Saved Address):", reponse);
                    var errorMsg = "Lỗi khi tự động tính phí ship.";
                     if (reponse.responseJSON && reponse.responseJSON.code_message_value) {
                        errorMsg = reponse.responseJSON.code_message_value;
                    } else if (reponse.responseText) {
                         try { var jsonResponse = JSON.parse(reponse.responseText); errorMsg = jsonResponse.message || jsonResponse.code_message_value || errorMsg; } catch (e) { }
                    }
                    alert(errorMsg);
                    resetShipFeeAndTotal();
                }
            });
        } else {
            console.warn("Địa chỉ cũ thiếu ID GHN. Yêu cầu người dùng chọn T/H/X để tính phí.");

            $('#tinhHuyenXaContainer').show();
            $('#province').prop('selectedIndex', 0);
            $('#district').empty().append('<option selected id="dfdistrict" value="">Chọn quận / huyện</option>');
            $('#ward').empty().append('<option selected id="dfward" value="">Chọn phường / xã</option>');
            $('#fee').text('0 VND');
            tienShip = 0;

            Swal.fire({
                icon: 'warning',
                title: 'Yêu cầu cập nhật địa chỉ',
                text: 'Địa chỉ đã lưu này cũ. Vui lòng chọn lại Tỉnh/Huyện/Xã để chúng tôi tính phí vận chuyển.',
                confirmButtonColor: '#111111'
            });
        }
    }

    function clearDiaChiForm() {
        $('#address').val('');

        if (isLoggedIn) {
            $('#saveAddressCheckboxContainer').show();
        }

        $('#tinhHuyenXaContainer').show();
        $('#province').prop('selectedIndex', 0);
        $('#district').empty().append('<option selected id="dfdistrict" value="">Chọn quận / huyện</option>');
        $('#ward').empty().append('<option selected id="dfward" value="">Chọn phường / xã</option>');

        resetShipFeeAndTotal();
    }

    function submitOrderAjax(objHoaDon) {
        $.ajax({
            async: false,
            type: 'POST',
            dataType: 'text',
            url: '/Home/Order',
            data: objHoaDon,
            success: function (response) {
                console.log(response);
                location.href = response;
            },
            error: function (response) {
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi!',
                    text: 'Đã có lỗi xảy ra khi đặt hàng. Vui lòng thử lại.',
                    confirmButtonColor: '#111111'
                });
            }
        });
    }

    function createhoadon() {
        var ten = $("#name").val();
        var email = $("#email").val();
        var sdt = $("#phone").val();
        var diachi = $("#address").val();
        var pttt = $('input[name="pttt"]:checked').val();
        var ghiChu = $("#note").val();

        $('.invalid-feedback').text('');
        $('.is-invalid').removeClass('is-invalid');
        var hasError = false;

        if (ten.trim().length == 0) {
            $('#name').addClass('is-invalid');
            $('#name').next('.invalid-feedback').text('Vui lòng nhập họ tên');
            hasError = true;
        }
        var phoneNumberRegex = /^(0|\+84)(3[2-9]|5[25689]|7[06-9]|8[1-5]|9[0-9])[0-9]{7}$/;
        if (sdt.trim().length == 0) {
            $('#phone').addClass('is-invalid');
            $('#phone').next('.invalid-feedback').text('Số điện thoại không được trống');
            hasError = true;
        }
        else if (!phoneNumberRegex.test(sdt)) {
            $('#phone').addClass('is-invalid');
            $('#phone').next('.invalid-feedback').text('Số điện thoại không hợp lệ (độ dài từ 9 - 10 ký tự, không chứa ký tự đặc biệt và khoảng trắng)');
            hasError = true;
        }
        
      
        var emailRegex = /^[a-zA-Z0-9._%+-]+@@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
        if (email.trim().length == 0) {
            $('#email').addClass('is-invalid');
            $('#email').next('.invalid-feedback').text('Vui lòng nhập email');
            hasError = true;
        }
        else if (!emailRegex.test(email)) {
            $('#email').addClass('is-invalid');
            $('#email').next('.invalid-feedback').text('Địa chỉ email không hợp lệ');
            hasError = true;
        }

        var isDropdownsVisible = $('#tinhHuyenXaContainer').is(':visible');
        var provinceID_ghn = 0;
        var districtID_ghn = 0;
        var wardCode_ghn = "";

        if (isDropdownsVisible) {
            tinh = $("#province option:selected").text().trim();
            huyen = $("#district option:selected").text().trim();
            xa = $("#ward option:selected").text().trim();

            provinceID_ghn = $("#province").val();
            districtID_ghn = $("#district").val();
            wardCode_ghn = $("#ward").val();

            if (tinh == "Chọn tỉnh / thành" || provinceID_ghn == "") {
                $('#province').addClass('is-invalid');
                $('#province').next('.invalid-feedback').text('Vui lòng chọn tỉnh thành');
                hasError = true;
            }
            if (huyen.trim().length == 0 || huyen == "Chọn quận / huyện" || districtID_ghn == "") {
                $('#district').addClass('is-invalid');
                $('#district').next('.invalid-feedback').text('Vui lòng chọn quận huyện');
                hasError = true;
            }
            if (xa.trim().length == 0 || xa == "Chọn phường / xã" || wardCode_ghn == "") {
                $('#ward').addClass('is-invalid');
                $('#ward').next('.invalid-feedback').text('Vui lòng chọn phường xã');
                hasError = true;
            }
        }

        if (diachi.trim().length == 0) {
            $('#address').addClass('is-invalid');
            $('#address').next('.invalid-feedback').text('Không để trống địa chỉ');
            hasError = true;
        }
        if (pttt == undefined) {
            $('#pttt-error').show();
            hasError = true;
        } else {
            $('#pttt-error').hide();
        }

        if (hasError) {
            var errorMsg = "Vui lòng điền đầy đủ thông tin!";
            if (!$("#name").val() || !$("#phone").val() || !$("#email").val() || !$("#address").val()) {
                errorMsg = "Vui lòng điền đầy đủ Họ tên, SĐT, Email và Địa chỉ.";
            } else if (isDropdownsVisible && (tinh == "Chọn tỉnh / thành" || huyen == "Chọn quận / huyện" || xa == "Chọn phường / xã")) {
                errorMsg = "Vui lòng chọn Tỉnh/Huyện/Xã để tính phí vận chuyển.";
            } else if (pttt == undefined) {
                errorMsg = "Vui lòng chọn phương thức thanh toán.";
            }

            Swal.fire({
                icon: 'error',
                title: 'Thông báo',
                text: errorMsg,
                confirmButtonText: 'Đã hiểu',
                confirmButtonColor: '#111111'
            });
            return;
        }

        Swal.fire({
            title: 'Xác nhận đặt hàng',
            text: "Bạn có chắc chắn muốn đặt hàng không?",
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#111111',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Xác nhận',
            cancelButtonText: 'Hủy'
        }).then((result) => {
            if (result.isConfirmed) {

                var objHoaDon = { Ten: ten, Email: email, SDT: sdt, DiaChi: diachi + ", " + xa + ", " + huyen + ", " + tinh, TienShip: tienShip, PhuongThucThanhToan: pttt, TongTien: tienShip + tienHang - tienVoucher - tienDiem, TenVoucher: voucher, Diem: diemTich, GhiChu: ghiChu };

                var isNewAddressFormVisible = $('#diaChiMoiContainer').is(':visible');
                var isSaveAddressChecked = $('#saveAddressCheckbox').is(':checked');
                var shouldSaveAddress = isLoggedIn && isSaveAddressChecked && isNewAddressFormVisible;

                if (shouldSaveAddress) {
                    var diaChiData = {
                        ID: '00000000-0000-0000-0000-000000000000',
                        IDKhachHang: currentUserID,
                        TenNguoiNhan: ten,
                        SoDienThoai: sdt,
                        DiaChiCuThe: diachi,
                        TinhThanh: tinh,
                        QuanHuyen: huyen,
                        PhuongXa: xa,
                        IsDefault: false,
                        ProvinceID: provinceID_ghn,
                        DistrictID: districtID_ghn,
                        WardCode: wardCode_ghn
                    };

                    $.ajax({
                        url: 'https://localhost:7095/api/DiaChi/Create',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify(diaChiData),
                        success: function (response) {
                            console.log('Lưu địa chỉ thành công!');
                            submitOrderAjax(objHoaDon);
                        },
                        error: function (xhr) {
                            var apiError = "Lỗi không xác định";
                            if (xhr.responseJSON) {
                                if (xhr.responseJSON.title) {
                                    apiError = xhr.responseJSON.title;
                                }
                                else if (xhr.responseJSON.message) {
                                    apiError = xhr.responseJSON.message;
                                }
                            }

                            Swal.fire({
                                icon: 'error',
                                title: 'Lỗi Lưu Địa Chỉ!',
                                text: `Không thể lưu địa chỉ của bạn (Lỗi: ${apiError}). Đơn hàng của bạn VẪN sẽ được xử lý.`,
                                confirmButtonColor: '#111111',
                            }).then(() => {
                                submitOrderAjax(objHoaDon);
                            });
                        }
                    });
                } else {
                    submitOrderAjax(objHoaDon);
                }
            }
        });
    }

    function usevoucher() {
        value = $("#voucher").val();
        $.ajax({
            async: true,
            type: 'GET',
            dataType: 'json',
            url: '/Home/UseVoucher',
            data: { ma: value, tongTien: tienHang },
            success: function (response) {
                if (response.trangThai == true) {
                    voucher = value;
                    if (response.hinhThuc == 1) {
                        tienVoucher = (tienHang * response.giaTri) / 100;
                    }
                    else if (response.hinhThuc == 0) {
                        tienVoucher = response.giaTri;
                    }
                    var ipVoucher = document.getElementById("moneyvoucher");
                    ipVoucher.hidden = false;
                    ipVoucher.innerHTML = "Số tiền giảm (Voucher)<span>" + tienVoucher.toLocaleString('it-IT', { style: 'currency', currency: 'VND' }) + " </span>";
                    var total = tienShip + tienHang - tienVoucher - tienDiem;
                    if (total < 0) {
                        total = 0
                    }
                    document.getElementById("total").innerHTML = total.toLocaleString('it-IT', { style: 'currency', currency: 'VND' });
                }
                else {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Voucher không hợp lệ',
                        text: response.loi,
                        confirmButtonText: 'OK',
                        confirmButtonColor: '#111111'
                    });
                }
            },
            error: function (response) {
                alert("Error");
            }
        });
    }

    function usediem() {
        var value = $("#diemTich").val();
        
       
        if (value > @(loginInfor.DiemTich == null ? 0 : loginInfor.DiemTich)) {
            Swal.fire({
                icon: 'warning',
                title: 'Không đủ điểm',
                text: 'Số điểm của bạn không đủ!',
                confirmButtonText: 'OK',
                confirmButtonColor: '#111111'
            });
        }
        else if (value < 0) {
            Swal.fire({
                icon: 'warning',
                title: 'Điểm không hợp lệ',
                text: 'Số điểm không thể âm!',
                confirmButtonText: 'OK',
                confirmButtonColor: '#111111'
            });
        } else if (isNaN(value)) {
            Swal.fire({
                icon: 'warning',
                title: 'Điểm không hợp lệ',
                text: 'Giá trị không hợp lệ!',
                confirmButtonText: 'OK',
                confirmButtonColor: '#111111'
            });
        }
        else {
            $.ajax({
                async: true,
                type: 'GET',
                dataType: 'json',
                url: '/Home/UseDDiemTich',
                data: { diem: value, id: '@loginInfor.Id', tongTien: tienHang },
                success: function (response) {
                    if (response.trangThai == true) {
                        diemTich = value;
                        var ipDiem = document.getElementById("moneyscore");
                        ipDiem.hidden = false;
                        tienDiem = response.soTienGiam;
                        ipDiem.innerHTML = "Số tiền giảm (Điểm)<span>" + tienDiem.toLocaleString('it-IT', { style: 'currency', currency: 'VND' }) + "</span>";
                        var total = tienShip + tienHang - tienVoucher - tienDiem;
                        if (total < 0) {
                            total = 0
                        }
                        document.getElementById("total").innerHTML = total.toLocaleString('it-IT', { style: 'currency', currency: 'VND' });
                    }
                    else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Lỗi',
                            text: response.loi,
                            confirmButtonText: 'OK',
                            confirmButtonColor: '#111111'
                        });
                    }
                },
                error: function (response) {
                    alert("Error");
                }
            });
        }
    }
</script>